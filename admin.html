<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BDE Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass rounded-3xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg">
                    <i class="fas fa-shield-alt text-3xl text-purple-600"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Admin Panel</h1>
                <p class="text-purple-100">Enter password to access</p>
            </div>

            <form id="loginForm">
                <div class="mb-6">
                    <label class="block text-white text-sm font-medium mb-2">
                        <i class="fas fa-key mr-2"></i>Password
                    </label>
                    <input type="password" id="adminPassword" required
                        class="w-full px-4 py-3 rounded-xl border-0 bg-white/90 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-300"
                        placeholder="Enter admin password">
                </div>
                
                <button type="submit" class="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold rounded-xl hover:shadow-lg transition-all">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
            </form>

            <div id="loginError" class="hidden mt-4 p-3 bg-red-500/90 text-white rounded-xl text-center text-sm">
                Incorrect password
            </div>

            <div class="text-center mt-6">
                <a href="/" class="text-purple-200 hover:text-white text-sm transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i>Back to Registration
                </a>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen p-4">
        <!-- Header -->
        <div class="glass rounded-2xl p-6 mb-6">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2">BDE Admin Dashboard</h1>
                    <p class="text-purple-100">Manage bureau members</p>
                </div>
                <div class="flex space-x-2 flex-wrap">
                    <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Export Excel
                    </button>
                    <button id="refreshBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="stat-card text-white p-6 rounded-2xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm">Total Members</p>
                        <p class="text-3xl font-bold" id="totalMembers">0</p>
                    </div>
                    <i class="fas fa-users text-4xl text-purple-200"></i>
                </div>
            </div>

            <div class="stat-card text-white p-6 rounded-2xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm">New Registrations</p>
                        <p class="text-3xl font-bold" id="recentMembers">0</p>
                    </div>
                    <i class="fas fa-user-plus text-4xl text-purple-200"></i>
                </div>
            </div>

            <div class="stat-card text-white p-6 rounded-2xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm">Top Field</p>
                        <p class="text-xl font-bold" id="topFiliere">-</p>
                    </div>
                    <i class="fas fa-graduation-cap text-4xl text-purple-200"></i>
                </div>
            </div>

            <div class="stat-card text-white p-6 rounded-2xl shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm">Top Role</p>
                        <p class="text-xl font-bold" id="topRole">-</p>
                    </div>
                    <i class="fas fa-briefcase text-4xl text-purple-200"></i>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="card rounded-2xl p-6 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="Search for a member..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300">
                </div>
                <select id="filiereFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300">
                    <option value="">All Fields</option>
                    <option value="DAI">DAI</option>
                    <option value="PME">PME</option>
                    <option value="ESA">ESA</option>
                    <option value="EII">EII</option>
                </select>
                <select id="roleFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300">
                    <option value="">All Roles</option>
                    <option value="President">President</option>
                    <option value="Vice President">Vice President</option>
                    <option value="Secretary">Secretary</option>
                    <option value="Treasurer">Treasurer</option>
                    <option value="Event Manager">Event Manager</option>
                    <option value="Communication Manager">Communication Manager</option>
                    <option value="Member">Regular Member</option>
                </select>
            </div>
        </div>

        <!-- Members Table -->
        <div class="card rounded-2xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Members List</h2>
                <span class="text-gray-600" id="membersCount">0 members</span>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Name</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Email</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">WhatsApp</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Field</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Level</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Role</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Registration Date</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-500">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="membersTable">
                        <tr>
                            <td colspan="8" class="text-center py-8 text-gray-500">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        class AdminPanel {
            constructor() {
                this.adminPassword = 'BDE2024';
                this.members = [];
                this.filteredMembers = [];
                this.init();
            }

            init() {
                this.bindEvents();
            }

            bindEvents() {
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadMembers();
                    this.loadStats();
                });
                document.getElementById('exportBtn').addEventListener('click', () => this.exportToExcel());
                document.getElementById('searchInput').addEventListener('input', () => this.filterMembers());
                document.getElementById('filiereFilter').addEventListener('change', () => this.filterMembers());
                document.getElementById('roleFilter').addEventListener('change', () => this.filterMembers());
            }

            handleLogin(e) {
                e.preventDefault();
                const password = document.getElementById('adminPassword').value;
                
                if (password === this.adminPassword) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    this.loadMembers();
                    this.loadStats();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('loginError').classList.add('hidden');
                    }, 3000);
                }
            }

            logout() {
                document.getElementById('adminDashboard').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('adminPassword').value = '';
            }

            async loadMembers() {
                try {
                    const response = await fetch('/api/members');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.members = result.members || [];
                        this.filteredMembers = [...this.members];
                        this.renderMembersTable();
                        this.updateMembersCount();
                        this.updateStats();
                    } else {
                        throw new Error(result.message || 'Failed to load members');
                    }
                    
                } catch (error) {
                    console.error('Error loading members:', error);
                    // En cas d'erreur, afficher un message
                    document.getElementById('membersTable').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-8 text-red-500">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Error loading data: ${error.message}</p>
                            </td>
                        </tr>
                    `;
                }
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/stats');
                    const result = await response.json();
                    
                    if (result.success) {
                        const stats = result.stats;
                        document.getElementById('totalMembers').textContent = stats.total || 0;
                        document.getElementById('recentMembers').textContent = stats.recent || 0;
                        
                        // Top field
                        const topFiliere = Object.keys(stats.byFiliere || {}).reduce((a, b) => 
                            (stats.byFiliere[a] || 0) > (stats.byFiliere[b] || 0) ? a : b, '');
                        document.getElementById('topFiliere').textContent = topFiliere || '-';
                        
                        // Top role
                        const topRole = Object.keys(stats.byRole || {}).reduce((a, b) => 
                            (stats.byRole[a] || 0) > (stats.byRole[b] || 0) ? a : b, '');
                        document.getElementById('topRole').textContent = topRole || '-';
                    } else {
                        // Fallback to local calculation
                        this.updateStats();
                    }
                } catch (error) {
                    console.error('Error loading stats:', error);
                    // Fallback to local calculation
                    this.updateStats();
                }
            }

            updateStats() {
                // Calculer les statistiques basées sur les données locales
                const total = this.members.length;
                const recent = this.members.filter(member => {
                    const memberDate = new Date(member.created_at);
                    const today = new Date();
                    const diffTime = Math.abs(today - memberDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays <= 7; // Membres des 7 derniers jours
                }).length;

                // Calculer par filière
                const byFiliere = {};
                this.members.forEach(member => {
                    byFiliere[member.filiere] = (byFiliere[member.filiere] || 0) + 1;
                });

                // Calculer par rôle
                const byRole = {};
                this.members.forEach(member => {
                    byRole[member.role] = (byRole[member.role] || 0) + 1;
                });

                // Mettre à jour l'interface
                document.getElementById('totalMembers').textContent = total;
                document.getElementById('recentMembers').textContent = recent;
                
                // Top field
                const topFiliere = Object.keys(byFiliere).reduce((a, b) => 
                    byFiliere[a] > byFiliere[b] ? a : b, '');
                document.getElementById('topFiliere').textContent = topFiliere || '-';
                
                // Top role
                const topRole = Object.keys(byRole).reduce((a, b) => 
                    byRole[a] > byRole[b] ? a : b, '');
                document.getElementById('topRole').textContent = topRole || '-';
            }

            renderMembersTable() {
                const tbody = document.getElementById('membersTable');
                
                if (this.filteredMembers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-8 text-gray-500">
                                <i class="fas fa-users-slash text-2xl mb-2"></i>
                                <p>No members found</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = this.filteredMembers.map(member => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900">${member.full_name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${member.email}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            <a href="https://wa.me/${member.whatsapp.replace(/[^0-9+]/g, '')}" target="_blank" 
                               class="text-green-600 hover:text-green-800">
                                ${member.whatsapp}
                            </a>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${member.filiere}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${member.niveau}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                ${member.role}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            ${new Date(member.created_at).toLocaleDateString()}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="adminPanel.deleteMember(${member.id})" 
                                class="text-red-600 hover:text-red-900 font-medium">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            filterMembers() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filiereFilter = document.getElementById('filiereFilter').value;
                const roleFilter = document.getElementById('roleFilter').value;

                this.filteredMembers = this.members.filter(member => {
                    const matchesSearch = member.full_name.toLowerCase().includes(searchTerm) ||
                                        member.email.toLowerCase().includes(searchTerm);
                    const matchesFiliere = !filiereFilter || member.filiere === filiereFilter;
                    const matchesRole = !roleFilter || member.role === roleFilter;

                    return matchesSearch && matchesFiliere && matchesRole;
                });

                this.renderMembersTable();
                this.updateMembersCount();
            }

            updateMembersCount() {
                document.getElementById('membersCount').textContent = 
                    `${this.filteredMembers.length} member${this.filteredMembers.length !== 1 ? 's' : ''}`;
            }

            async deleteMember(id) {
                if (!confirm('Are you sure you want to delete this member?')) return;

                try {
                    const response = await fetch(`/api/members?id=${id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        // Remove from local arrays
                        this.members = this.members.filter(member => member.id !== id);
                        this.filteredMembers = this.filteredMembers.filter(member => member.id !== id);
                        
                        this.renderMembersTable();
                        this.updateMembersCount();
                        this.updateStats();
                        
                        alert('Member deleted successfully');
                    } else {
                        throw new Error(result.message || 'Failed to delete member');
                    }
                } catch (error) {
                    console.error('Error deleting member:', error);
                    alert(`Error deleting member: ${error.message}`);
                }
            }

            exportToExcel() {
                alert('Export functionality would be implemented here');
                // Implémentation réelle nécessiterait une bibliothèque comme SheetJS
            }
        }

        // Initialiser l'admin panel
        const adminPanel = new AdminPanel();
    </script>
</body>
</html>
